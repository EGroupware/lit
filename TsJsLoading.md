# Loading of TypeScript and JavaScript

## Current situation in EGroupware
* [server-side](https://github.com/EGroupware/egroupware/blob/master/api/src/Framework/IncludeMgr.php) determines dependencies AND execution-order using a [custom syntax](https://github.com/EGroupware/egroupware/blob/master/calendar/js/app.ts#L13-L21) doublicating TS import statements
* dependencies and their execution order are passed as attribute "data-include" on egw.js script tag to client-side
* [egw.js uses LAB.js](https://github.com/EGroupware/egroupware/blob/master/api/js/jsapi/egw.js#L168-L169) to parallel load all dependencies and defer execution until all are loaded and executed in the predefined order
* [client-side loader egw.includeJS](https://github.com/EGroupware/egroupware/blob/master/api/js/jsapi/egw_files.js#L141-L150) also uses LAB.js and has some understanding of our bundeling
* we currently use grunt with grunt-terser plugin to concatinate and minify our dependencies into bundles as defined in [Gruntfile.js](https://github.com/EGroupware/egroupware/blob/master/Gruntfile.js)
* Gruntfile.js itself is generated by [updateGruntfile.php](https://github.com/EGroupware/egroupware/blob/master/updateGruntfile.php) use same server-side codes as described above
* TypeScript is [configured to "moduleResolution": "node"](https://github.com/EGroupware/egroupware/blob/master/tsconfig.json#L11) with a [small require() shim in egw.js](https://github.com/EGroupware/egroupware/blob/master/api/js/jsapi/egw.js#L462-L471) loading everything in global scope
* if minified bundles or single JavaScript files are used is determinded by a configuration in EGroupware, which can be turned off mostly for development systems

## Downsides of current workflow
* not using native ES5 import, but ancient LAB.js
* everything is imported into global scope
* execution is defered until all javascript dependencies are loaded AND executed
* current workflow does not "understand" ES5 modules directly and makes it hard to even create a prototype using [LitElement/webcomponents](https://github.com/EGroupware/lit/blob/main/README.md)
* we're currently not generating (working) map-files, if the default bundeling is enabled
* no (automatic) Tree Shaking (Unused export elimination and export mangling)

## Currently used bundels from [Gruntfile.js](https://github.com/EGroupware/egroupware/blob/master/Gruntfile.js)
* api/js/jsapi/jsapi.min.js containing everything from the egw object (JavaScript) plus other dependencies like jQuery(UI), dhtmlx*, egw_action and choosen
* api/js/etemplate/etempalte2.min.js contains all non-app-specific eT2 widgets
* TinyMCE (already minified bundle from vendor directory)
* one of the template bundles also containing the api/js/framework code
  * pixelegg/js/fw_pixelegg.min.js standard desktop framework
  * pixelegg/js/fw_mobile.min.js mobile framework
* app-specific bundles for applications using more then an app.js/ts file eg. app-specific eT2 widgets
  * mail/js/app.min.js (just because it's so big)
  * calendar/js/app.min.js (lots of eT2 widgets)
  * notifications/js/notificationajaxpopup.min.js (not sure why ...)
  * projectmanager/js/app.min.js (eT2 gantt-chart widget plus it's dhtmlx-gant dependencies)
  * smallpart/js/app.min.js (lots of eT2 widgets)
  * other app's $app/js/app.js are currently not minified as they are relativ small / little to gain
* egw.js and LAB.js are loaded directly via script tag in head to load the above

## Ideas for a new solution using ES5 native import
* use [Webpack](https://webpack.js.org/) to bundle and build our dependencies
* use newer [Rollup](https://rollupjs.org/guide/en/) instead
* use an [ES5 module shim](https://github.com/guybedford/es-module-shims) with [Import Maps](https://github.com/wicg/import-maps#the-basic-idea) support
* ...

## Problems from our existing code-base the above candidates need to deal with
* not all code is already TypeScript or modern JavaScript modules eg. client-side API (egw object), framework and egw_action stuff
* non-TypeScript code contains no import statements currently AND TypeScript not always all necessary onces
* our ContentSecurityPolicy does NOT allow to use inline javascript (could be worked around using a nonce)
* ...

# The Plan?
1. Change to proper modules
2. ???
3. Everything works
